"
Builds completion result sets using suggestions generated by the Ollama API.

"
Class {
	#name : 'CoPharoCopilotResultSetBuilder',
	#superclass : 'CoResultSetBuilder',
	#category : 'AI-Pharo-Copilot',
	#package : 'AI-Pharo-Copilot'
}

{ #category : 'instance creation' }
CoPharoCopilotResultSetBuilder class >> initializeOnContext: aSystemCompletionContext [ 
    ^ self new
        initializeOnContext: aSystemCompletionContext;
        yourself
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> behaviorFromContext: aContext [ 

        ^ self
                valueFrom: aContext
                usingSelectors: #(behavior selectedClass classOrMetaClass methodClass)
                default: nil
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> buildCompletion [

        | context prefix suffix contextInfo process fetcher |
        context := completionContext.
        prefix := context source copyFrom: 1 to: context position.
        suffix := context position < context source size
                          ifTrue: [ context source copyFrom: context position + 1 to: context source size ]
		          ifFalse: [ '' ].
	contextInfo := Dictionary new
		               at: #contextClass put: context class name;
		               at: #cursorPosition put: context position;
		               at: #sourceSize put: context source size;
		               at: #fullSource put: context source;
		               at: #prefix put: prefix;
		               at: #suffix put: suffix;
		               yourself.
		        process := [
                self
                        processCompletionFor: context
                        prefix: prefix
                        suffix: suffix
                        contextInfo: contextInfo ] forkAt: Processor userBackgroundPriority.
	

	
	CoCopilotLogger logBackEndEvent: 'Dispatched asynchronous completion fetch' details: (Dictionary new
                        at: #processPriority put: Processor userBackgroundPriority;
                        at: #processId put: process identityHash;
			 yourself).

	fetcher := CoCollectionFetcher onCollection: #(  ).
	^ CoResultSet fetcher: fetcher
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> cleanedContentFrom: aString [

	| text start rest closingIndex body newlineIndex firstLine delimiter idx |
        text := (aString ifNil: [ '' ]) asString.
        text isEmpty ifTrue: [ ^ '' ].

        start := text indexOfSubCollection: '```' startingAt: 1 ifAbsent: [ 0 ].
        start > 0 ifTrue: [
                rest := start + 3 <= text size
                        ifTrue: [ text copyFrom: start + 3 to: text size ]
                        ifFalse: [ '' ].
                closingIndex := self indexOfClosingFenceIn: rest startingAt: 1.
                closingIndex := closingIndex = 0
                        ifTrue: [ rest size + 1 ]
                        ifFalse: [ closingIndex ].
                body := closingIndex <= 1
                        ifTrue: [ '' ]
                        ifFalse: [ rest copyFrom: 1 to: closingIndex - 1 ].
                newlineIndex := body indexOf: Character lf ifAbsent: [ 0 ].
                newlineIndex > 0
                        ifTrue: [
                                firstLine := body copyFrom: 1 to: newlineIndex - 1.
                                (firstLine isEmpty or: [ self isLanguageSpec: firstLine ]) ifTrue: [
                                        body := newlineIndex < body size
                                                ifTrue: [ body copyFrom: newlineIndex + 1 to: body size ]
                                                ifFalse: [ '' ] ] ]
                        ifFalse: [
                                (self isLanguageSpec: body) ifTrue: [ body := '' ] ].
                ^ body trimBoth ].

        delimiter := String lf , String lf.
        idx := text indexOfSubCollection: delimiter startingAt: 1 ifAbsent: [ 0 ].
        body := idx = 0
                        ifTrue: [ text ]
                        ifFalse: [ text copyFrom: 1 to: idx - 1 ].
        ^ body trimBoth
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> defaultFilePath [

        ^ CopilotSettings defaultFilePathToken
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> defaultRepositoryName [

        ^ CopilotSettings defaultRepositoryName
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> fileReferencePathFromContext: aContext [

        | reference candidate |
        reference := self
                valueFrom: aContext
                usingSelectors: #(fileReference file)
                default: nil.
        reference ifNotNil: [
                candidate := self
                        valueFrom: reference
                        usingSelectors: #(pathString fullName)
                        default: reference.
                ^ self safeStringFrom: candidate default: nil
        ].
        candidate := self
                valueFrom: aContext
                usingSelectors: #(sourceFile fileName filePath)
                default: nil.
        ^ self safeStringFrom: candidate default: nil
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> fimContextDetailsForContext: aContext prefix: prefixString suffix: suffixString contextInfo: contextInfo [

        | details fullSource |
        details := Dictionary new.
        details at: #repoName put: (self repositoryNameForContext: aContext).
        details at: #filePath1 put: (self primaryFilePathForContext: aContext).
        fullSource := contextInfo at: #fullSource ifAbsent: [ prefixString , suffixString ].
        details at: #fileContent1 put: (self safeStringFrom: fullSource default: '').
        details at: #filePath2 put: ''.
        details at: #fileContent2 put: ''.
        details at: #filePath3 put: ''.
        details at: #codeMiddle put: ''.
        ^ details
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> indexOfClosingFenceIn: text startingAt: startIndex [ 

        | idx lastValid size |
        text isEmpty ifTrue: [ ^ 0 ].
        size := text size.
        lastValid := 0.
        idx := text indexOfSubCollection: '```' startingAt: startIndex ifAbsent: [ 0 ].
        [ idx > 0 ] whileTrue: [
                | before after |
                before := idx = 1 or: [
                        | prev |
                        prev := text at: idx - 1.
                        prev = Character lf or: [ prev = Character cr ] ].
                after := (idx + 3 > size)
                        or: [ | next |
                                next := text at: idx + 3.
                                next = Character lf or: [ next = Character cr ] ].
                (before and: after) ifTrue: [ lastValid := idx ].
                idx := text indexOfSubCollection: '```' startingAt: idx + 1 ifAbsent: [ 0 ].
        ].
        ^ lastValid
]

{ #category : 'initialization' }
CoPharoCopilotResultSetBuilder >> initializeOnContext: aSystemCompletionContext [ 

    completionContext := aSystemCompletionContext
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> isLanguageSpec: aString [

	        | candidate trimmed |
        aString ifNil: [ ^ false ].
        candidate := aString asString.
        candidate isEmpty ifTrue: [ ^ false ].
        trimmed := candidate trimBoth.
        (trimmed size = candidate size) ifFalse: [ ^ false ].
        candidate := trimmed.
        ^ (#('smalltalk' 'pharo' 'bash' 'sh' 'shell' 'python'
                'javascript' 'json' 'java' 'c' 'cpp' 'xml' 'html'
                'ruby' 'php' 'sql' 'yaml' 'yml' 'go' 'rust' 'typescript')
                includes: candidate asLowercase)
                or: [ candidate allSatisfy: [ :ch |
                                ch isLetter
                                        or: [ ch isDigit
                                        or: [ '#+-_' includes: ch ] ] ] ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> primaryFilePathForContext: aContext [

        | path behavior selector behaviorName selectorName |
        path := self fileReferencePathFromContext: aContext.
        path ifNotNil: [ ^ path ].
        behavior := self behaviorFromContext: aContext.
        selector := self selectorFromContext: aContext.
        behaviorName := self safeStringFrom: (behavior ifNil: [ nil ] ifNotNil: [
                (behavior respondsTo: #name)
                        ifTrue: [ behavior name ]
                        ifFalse: [ behavior ] ]) default: nil.
        selectorName := self safeStringFrom: selector default: nil.
        (behaviorName notNil and: [ selectorName notNil ]) ifTrue: [
                ^ behaviorName , '>>', selectorName
        ].
        behaviorName ifNotNil: [ ^ behaviorName , '.st' ].
        selectorName ifNotNil: [ ^ selectorName , '.st' ].
        ^ self defaultFilePath
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> processCompletionFor: aContext prefix: prefixString suffix: suffixString contextInfo: contextInfo [

        [
                                | client rawResponse rawResponseString content contextDetails |
                contextDetails := self
                        fimContextDetailsForContext: aContext
                        prefix: prefixString
                        suffix: suffixString
                        contextInfo: contextInfo.
                contextInfo
                        at: #repositoryName put: (contextDetails at: #repoName ifAbsent: [ CopilotSettings defaultRepositoryName ]);
                        at: #primaryFilePath put: (contextDetails at: #filePath1 ifAbsent: [ CopilotSettings defaultFilePathToken ]).
                CoCopilotLogger
                        logFrontEndEvent: 'Preparing completion request'
                        details: contextInfo.

                client := OllamaClient new.
                                rawResponse := client
                        generateForPrefix: prefixString
                        suffix: suffixString
                        contextDetails: contextDetails.
                rawResponseString := [ rawResponse asString ]
                        on: Error
                        do: [ rawResponse printString ].
                CoCopilotLogger
                        logBackEndEvent: 'Received raw suggestion payload'
                        details: (Dictionary new
                                at: #rawResponseClass put: rawResponse class name;
                                at: #rawResponse put: rawResponseString;
                                yourself).
                content := rawResponseString.
                [
                        | parsed |
                        parsed := STONJSON fromString: rawResponseString.
                        (parsed isKindOf: Dictionary) ifTrue: [
                                content := parsed
                                        at: #response
                                        ifAbsent: [ parsed at: 'response' ifAbsent: [ rawResponseString ] ] ] ]
                        on: Error
                        do: [ :ex |
                                CoCopilotLogger
                                        logBackEndEvent: 'Failed to parse suggestion payload as JSON'
                                        details: (Dictionary new
                                                at: #error put: ex messageText;
                                                at: #rawResponse put: rawResponseString;
                                                yourself) ].

                content := self cleanedContentFrom: content asString.
                CoCopilotLogger
                        logBackEndEvent: 'Normalized suggestion content'
                        details: (Dictionary new
                                at: #cleanedContent put: content;
                                at: #cleanedLength put: content size;
                                yourself).

                content isEmpty
ifFalse: [
aContext
                                ifNil: [
                                        CoCopilotLogger
                                                logFrontEndEvent: 'Skipped applying suggestion - missing context'
                                                details: (Dictionary new
                                                        at: #appliedContent put: content;
                                                        at: #appliedLength put: content size;
                                                        at: #reason put: 'Completion context was nil';
                                                        yourself) ]
                                ifNotNil: [
                                        aContext replaceTokenInEditorWith: content.
                                        CoCopilotLogger
                                                logFrontEndEvent: 'Applied suggestion to editor'
                                                details: (Dictionary new
                                                        at: #appliedContent put: content;
                                                        at: #appliedLength put: content size;
                                                        yourself) ] ]
                ifTrue: [
                        CoCopilotLogger
                                logFrontEndEvent: 'No suggestion content to apply'
                                details: (Dictionary new
                                        at: #reason put: 'Generated content was empty';
                                        at: #rawResponse put: rawResponseString;                                        yourself) ]
        ] on: Error do: [ :ex |
                CoCopilotLogger
                        logError: 'Asynchronous completion failed'
                        origin: #CoPharoCopilotResultSetBuilder
                        exception: ex
                        payload: (Dictionary new
                                at: #requestDetails put: contextInfo copy;
                                at: #prefixLength put: prefixString size;
                                at: #suffixLength put: suffixString size;
                                yourself) ]
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> repositoryNameForContext: aContext [

        | packageCandidate behavior packageName |
        packageCandidate := self
                valueFrom: aContext
                usingSelectors: #(package selectedPackage packageName)
                default: nil.
        packageName := self safeStringFrom: packageCandidate default: nil.
        packageName ifNotNil: [ ^ packageName ].
        behavior := self behaviorFromContext: aContext.
        behavior ifNil: [ ^ self defaultRepositoryName ].
        packageCandidate := self
                valueFrom: behavior
                usingSelectors: #(package)
                default: nil.
        packageCandidate ifNotNil: [
                packageName := self safeStringFrom: ((packageCandidate respondsTo: #name)
                        ifTrue: [ packageCandidate name ]
                        ifFalse: [ packageCandidate ]) default: nil.
                packageName ifNotNil: [ ^ packageName ]
        ].
        packageCandidate := self
                valueFrom: behavior
                usingSelectors: #(category categoryName)
                default: nil.
        packageName := self safeStringFrom: packageCandidate default: nil.
        packageName ifNotNil: [ ^ packageName ].
        ^ self defaultRepositoryName
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> safeStringFrom: anObject default: defaultString [

        | value |
        anObject isNil ifTrue: [ ^ defaultString ].
        value := [ anObject asString ] on: Error do: [ nil ].
        value ifNil: [ value := [ anObject printString ] on: Error do: [ nil ] ].
        value ifNil: [ ^ defaultString ].
        value := value asString.
        value isEmpty ifTrue: [ ^ defaultString ].
        ^ value
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> selectorFromContext: aContext [

        ^ self
                valueFrom: aContext
                usingSelectors: #(selector selectedSelector methodSelector currentSelector)
                default: nil
]

{ #category : 'API - building' }
CoPharoCopilotResultSetBuilder >> valueFrom: anObject usingSelectors: selectors default: defaultValue [

        anObject isNil ifTrue: [ ^ defaultValue ].
        selectors do: [ :selector |
                (anObject respondsTo: selector) ifTrue: [
                        [ | value |
                        value := anObject perform: selector.
                        value ifNotNil: [ ^ value ] ]
                                on: Error
                                do: [ :ignored | ] ] ].
        ^ defaultValue
]
